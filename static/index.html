<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SubwaySentinal</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1a1a2e">
    <link rel="apple-touch-icon" href="/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d4ff, #7b2cbf);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .last-updated {
            text-align: center;
            color: #888;
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .station-toggle {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .station-btn {
            padding: 10px 20px;
            border: 2px solid #7b2cbf;
            background: transparent;
            color: #fff;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .station-btn.active {
            background: linear-gradient(135deg, #7b2cbf 0%, #9d4edd 100%);
            border-color: transparent;
        }

        .station-btn:hover {
            transform: scale(1.05);
        }

        .recommendation {
            background: linear-gradient(135deg, #ff6319 0%, #ff8c00 100%);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(255, 99, 25, 0.3);
            transition: background 0.3s, box-shadow 0.3s;
        }

        .recommendation.recommend-g {
            background: linear-gradient(135deg, #6cbe45 0%, #8cd867 100%);
            box-shadow: 0 10px 40px rgba(108, 190, 69, 0.3);
        }

        .recommendation h2 {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .recommendation .train {
            font-size: 4rem;
            font-weight: bold;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h3 {
            font-size: 1rem;
            color: #00d4ff;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .train-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .train-row:last-child {
            border-bottom: none;
        }

        .train-badge {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .train-badge.F {
            background: #ff6319;
        }

        .train-badge.G {
            background: #6cbe45;
        }

        .train-badge.B {
            background: #ff6319;
        }

        .train-badge.D {
            background: #ff6319;
        }

        .train-badge.A {
            background: #0039a6;
        }

        .train-time {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .train-label {
            color: #888;
            font-size: 0.9rem;
        }

        .not-found {
            color: #666;
            font-style: italic;
        }

        .alert {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .viable {
            color: #00ff88;
            font-weight: bold;
        }

        .refresh-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #00d4ff 0%, #0077b6 100%);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 212, 255, 0.4);
        }

        .error {
            background: #e74c3c;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="text-align: center; margin-bottom: 10px;">
            <img src="/logo.png" alt="SubwaySentinal" style="max-width: 200px; height: auto;">
        </div>
        <p class="last-updated">Last updated: <span id="lastUpdated">--</span></p>

        <div class="station-toggle">
            <button class="station-btn active" id="carrollBtn" onclick="selectStation('carroll')">Carroll St</button>
            <button class="station-btn" id="smithBtn" onclick="selectStation('smith')">Smith-9th</button>
        </div>

        <div class="recommendation" id="recommendation">
            <h2>Recommended</h2>
            <div class="train" id="recommendedTrain">--</div>
        </div>

        <div class="card">
            <h3 id="stationName">At Carroll St</h3>
            <div class="train-row">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="train-badge F">F</div>
                    <div>
                        <span class="train-label">Next F train</span>
                        <div style="color: #888; font-size: 0.8rem;" id="fLafayetteEta"></div>
                    </div>
                </div>
                <div class="train-time" id="fTime">--</div>
            </div>
            <div class="train-row">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="train-badge G">G</div>
                    <span class="train-label">Next G train</span>
                </div>
                <div class="train-time" id="gTime">--</div>
            </div>
        </div>

        <div class="card" id="gSwitchCard" style="display: none;">
            <h3>G-Switch Alert</h3>
            <div class="alert" id="gSwitchAlert"></div>
        </div>

        <div class="card">
            <h3>B/D Express at Lafayette</h3>
            <p style="color: #888; margin-bottom: 10px;">F arrives at Lafayette in: <span id="fAtLafayette">--</span>
                min</p>
            <div id="bdTrains"></div>
            <div id="bdExpressAlert" style="display: none;" class="alert"></div>
        </div>

        <div class="card" id="serviceAlertsCard" style="display: none;">
            <h3 onclick="toggleAlerts()"
                style="cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
                ⚠️ Service Alerts
                <span id="alertsToggle" style="font-size: 0.8rem;">▼</span>
            </h3>
            <div id="serviceAlertsList" style="display: none;"></div>
        </div>

        <button class="refresh-btn" onclick="loadData()">Refresh</button>
    </div>

    <script>
        const BASE_URL = 'https://realtimerail.nyc/transiter/v0.6/systems/us-ny-subway/stops';
        const ROUTE_BASE_URL = 'https://realtimerail.nyc/transiter/v0.6/systems/us-ny-subway/routes';
        const ALERTS_BASE_URL = 'https://realtimerail.nyc/transiter/v0.6/systems/us-ny-subway/alerts';

        // Station configurations - Manhattan-bound (N suffix)
        // Travel times are fallbacks; will be calculated dynamically from trip data
        const STATIONS = {
            carroll: {
                name: 'Carroll St',
                stopId: 'F21N',
                travelTime: 12 * 60  // ~12 min to Lafayette (fallback)
            },
            smith: {
                name: 'Smith-9th Sts',
                stopId: 'F22N',
                travelTime: 13 * 60  // ~13 min to Lafayette (fallback)
            }
        };

        const HOYT_STOP = 'A42N';
        const LAFAYETTE_STOP = 'D21N';

        let currentStation = localStorage.getItem('station') || 'carroll';

        function selectStation(station) {
            currentStation = station;
            localStorage.setItem('station', station);

            // Update UI
            document.getElementById('carrollBtn').classList.toggle('active', station === 'carroll');
            document.getElementById('smithBtn').classList.toggle('active', station === 'smith');
            document.getElementById('stationName').textContent = `At ${STATIONS[station].name}`;

            loadData();
        }

        async function getArrivals(stopId) {
            const response = await fetch(`${BASE_URL}/${stopId}`);
            return response.json();
        }

        function parseArrivals(data, routes = null) {
            const arrivals = [];
            const now = Date.now() / 1000;

            const stopTimes = data.stopTimes || [];
            for (const st of stopTimes) {
                const trip = st.trip || {};
                const routeId = trip.route?.id || '';
                const tripUrl = trip.resource?.url || null;

                if (routes && !routes.includes(routeId)) continue;

                const arrivalInfo = st.arrival || st.departure || {};
                const arrivalTime = parseInt(arrivalInfo.time);
                if (arrivalTime) {
                    const secondsUntil = arrivalTime - now;
                    if (secondsUntil > 0) {
                        arrivals.push({ route: routeId, seconds: secondsUntil, tripUrl });
                    }
                }
            }

            return arrivals.sort((a, b) => a.seconds - b.seconds);
        }

        function getNextTrain(arrivals, routes = null) {
            for (const { route, seconds, tripUrl } of arrivals) {
                if (!routes || routes.includes(route)) {
                    return { route, seconds, tripUrl };
                }
            }
            return { route: null, seconds: null, tripUrl: null };
        }

        async function getLafayetteArrivalFromTrip(tripUrl) {
            // Fetch trip data and find Lafayette arrival time
            if (!tripUrl) return null;

            try {
                const response = await fetch(tripUrl);
                const tripData = await response.json();
                const now = Date.now() / 1000;

                const stopTimes = tripData.stopTimes || [];
                for (const st of stopTimes) {
                    const stopId = st.stop?.id;
                    if (stopId === LAFAYETTE_STOP) {
                        const arrivalTime = parseInt(st.arrival?.time);
                        if (arrivalTime) {
                            return arrivalTime - now;  // seconds until Lafayette
                        }
                    }
                }
            } catch (e) {
                console.error('Error fetching trip:', e);
            }
            return null;
        }

        async function getServiceAlerts(routes) {
            // Stage 1: Get alert IDs from each route
            const alertIds = new Map();

            for (const route of routes) {
                try {
                    const response = await fetch(`${ROUTE_BASE_URL}/${route}`);
                    const data = await response.json();
                    if (data.alerts) {
                        for (const alert of data.alerts) {
                            if (alert.id && !alertIds.has(alert.id)) {
                                alertIds.set(alert.id, route);
                            }
                        }
                    }
                } catch (e) { console.error(e); }
            }

            // Stage 2: Fetch full details for each alert
            const alerts = [];

            for (const [alertId, route] of alertIds) {
                try {
                    const response = await fetch(`${ALERTS_BASE_URL}/${alertId}`);
                    const alert = await response.json();

                    alerts.push({
                        route: route,
                        header: (Array.isArray(alert.header) && alert.header.length > 0 && alert.header[0].text) ? alert.header[0].text : 'Service Alert',
                        description: (Array.isArray(alert.description) && alert.description.length > 0 && alert.description[0].text) ? alert.description[0].text : ''
                    });
                } catch (e) { console.error(e); }
            }

            return alerts;
        }

        async function loadData() {
            try {
                const station = STATIONS[currentStation];
                const travelTime = station.travelTime;

                const [stationData, hoytData, lafayetteData] = await Promise.all([
                    getArrivals(station.stopId),
                    getArrivals(HOYT_STOP),
                    getArrivals(LAFAYETTE_STOP)
                ]);

                // Fetch alerts in parallel (but don't block main data if it fails)
                getServiceAlerts(['F', 'G', 'B', 'D']).then(alerts => {
                    const alertCard = document.getElementById('serviceAlertsCard');
                    const alertList = document.getElementById('serviceAlertsList');

                    if (alerts.length > 0) {
                        alertCard.style.display = 'block';
                        alertList.innerHTML = alerts.map(alert => `
                            <div class="alert" style="background: rgba(255, 255, 255, 0.05); margin-bottom: 10px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <div class="train-badge ${alert.route}" style="width: 30px; height: 30px; font-size: 1rem;">${alert.route}</div>
                                    <strong style="font-size: 0.9rem;">${alert.header}</strong>
                                </div>
                                <p style="font-size: 0.8rem; color: #ccc; max-height: 100px; overflow-y: auto;">${alert.description}</p>
                            </div>
                        `).join('');
                    } else {
                        alertCard.style.display = 'none';
                    }
                });

                const stationArrivals = parseArrivals(stationData);
                const { route: fRoute, seconds: fTime, tripUrl: fTripUrl } = getNextTrain(stationArrivals, ['F']);
                const { route: gRoute, seconds: gTime } = getNextTrain(stationArrivals, ['G']);

                // G-Switch logic
                let gSwitch = null;
                if (gTime && fTime && (fTime - gTime) >= 6 * 60) {
                    const hoytArrivals = parseArrivals(hoytData);
                    const { seconds: aTime } = getNextTrain(hoytArrivals, ['A']);
                    if (aTime) {
                        const gToHoytTime = gTime + 3 * 60;
                        if (aTime <= gToHoytTime + 5 * 60) {
                            gSwitch = 'G to A';
                        }
                    }
                }

                // B/D Express logic - get Lafayette arrival directly from trip data
                let bdExpress = null;
                const catchableBd = [];
                let fAtLafayette = null;

                if (fTime && fTripUrl) {
                    // Fetch actual Lafayette arrival from the F train's trip data
                    fAtLafayette = await getLafayetteArrivalFromTrip(fTripUrl);
                }

                // Fallback to calculated time if trip lookup fails
                if (fAtLafayette === null && fTime) {
                    fAtLafayette = fTime + travelTime;
                }

                if (fAtLafayette) {
                    const lafayetteArrivals = parseArrivals(lafayetteData, ['B', 'D']);

                    for (const { route, seconds: bdTime } of lafayetteArrivals) {
                        const wait = bdTime - fAtLafayette;
                        if (wait >= 0) {
                            const viable = wait <= 3 * 60;
                            catchableBd.push({ route, time: bdTime / 60, wait: wait / 60, viable });
                            if (viable && !bdExpress) {
                                bdExpress = `Transfer to ${route} at Lafayette`;
                            }
                            if (catchableBd.length >= 2) break;
                        }
                    }
                }

                // Recommendation
                let recommended;
                if (gSwitch) {
                    recommended = 'G';
                } else if (bdExpress) {
                    if (bdExpress.includes('B')) {
                        recommended = 'F → B';
                    } else if (bdExpress.includes('D')) {
                        recommended = 'F → D';
                    } else {
                        recommended = 'F';
                    }
                } else {
                    recommended = 'F';
                }

                // Update UI
                document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
                document.getElementById('recommendedTrain').textContent = recommended;

                // Dynamic recommendation box color
                const recBox = document.getElementById('recommendation');
                if (recommended === 'G') {
                    recBox.classList.add('recommend-g');
                } else {
                    recBox.classList.remove('recommend-g');
                }

                document.getElementById('fTime').textContent = fTime ? `${(fTime / 60).toFixed(1)} min` : '--';
                document.getElementById('fTime').className = fTime ? 'train-time' : 'train-time not-found';

                const fAtLafayetteMin = fAtLafayette ? fAtLafayette / 60 : null;
                document.getElementById('fLafayetteEta').textContent = fAtLafayetteMin ? `→ Lafayette in ${fAtLafayetteMin.toFixed(1)} min` : '';
                document.getElementById('fAtLafayette').textContent = fAtLafayetteMin ? fAtLafayetteMin.toFixed(1) : '--';

                document.getElementById('gTime').textContent = gTime ? `${(gTime / 60).toFixed(1)} min` : 'Not running';
                document.getElementById('gTime').className = gTime ? 'train-time' : 'train-time not-found';

                // G-Switch
                const gSwitchCard = document.getElementById('gSwitchCard');
                if (gSwitch) {
                    gSwitchCard.style.display = 'block';
                    document.getElementById('gSwitchAlert').textContent = gSwitch;
                } else {
                    gSwitchCard.style.display = 'none';
                }

                // B/D Express
                const bdTrainsDiv = document.getElementById('bdTrains');
                if (catchableBd.length > 0) {
                    bdTrainsDiv.innerHTML = catchableBd.map(train => `
                        <div class="train-row">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div class="train-badge ${train.route}">${train.route}</div>
                                <span class="train-label">in ${train.time.toFixed(1)} min</span>
                            </div>
                            <div>
                                <span class="${train.viable ? 'viable' : ''}">wait ${train.wait.toFixed(1)} min</span>
                                ${train.viable ? ' ✓' : ''}
                            </div>
                        </div>
                    `).join('');
                } else {
                    bdTrainsDiv.innerHTML = '<p class="not-found">No catchable B/D trains</p>';
                }

                const bdAlert = document.getElementById('bdExpressAlert');
                if (bdExpress) {
                    bdAlert.style.display = 'block';
                    bdAlert.textContent = '✓ ' + bdExpress;
                } else {
                    bdAlert.style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('recommendation').innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        function toggleAlerts() {
            const list = document.getElementById('serviceAlertsList');
            const toggle = document.getElementById('alertsToggle');
            if (list.style.display === 'none') {
                list.style.display = 'block';
                toggle.textContent = '▲';
            } else {
                list.style.display = 'none';
                toggle.textContent = '▼';
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            selectStation(currentStation);
        });

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js').catch(() => { });
        }
    </script>
</body>

</html>